#Basic functions for layering colors. t=top and b=bottom color
#       self.blendingModes  = {
#           'top'       : (lambda t, b: t ),
#           'bottom'    : (lambda t, b: b ),
#           'add'       : (lambda t, b: t + b ),
#           'subtract'  : (lambda t, b: (b - t) * (b - t > 0)),
#           'subtract_b': (lambda t, b: (t - b) * (t - b > 0)),
#           'difference': (lambda t, b: (t - b) * (t > b) + (b - t) * (t <= b)),
#           'average'   : (lambda t, b: 0.5 * (t + b)),
#           'multiply'  : (lambda t, b: t * b),
#           'divide'    : (lambda t, b: t / b if b > 0 else 0 ),
#           'divide_inv': (lambda t, b: b / t if t > 0 else 0 ),
#           'screen'    : (lambda t, b: 1.0 - (1.0-t)*(1.0-b) ),
#           'lighten'   : (lambda t, b: t * (t > b) +  b * (t <= b)),
#           'darken'    : (lambda t, b: t * (t < b) +  b * (t >= b)),
#           'overlay'   : (lambda t, b: \
#                               2.0 * t * b if t > 0.5 else \
#                               1.0 - (2.0 * (1.0-t) * (1.0-b)))
#          }


# [neopixel front_button_led]
# pin: PB000
# chain_count: 1
# color_order: GRB

[neopixel sb_leds]
pin: EBBCan: PD3
chain_count: 3
color_order: GRBW
initial_RED: 1
initial_GREEN: 0.3686
initial_BLUE: 0.5
initial_WHITE: 0.5

[neopixel case_light]
pin: PB0
chain_count: 50
# initial_RED: 1
# initial_GREEN: 0.3686
# initial_BLUE: 0.5
# initial_WHITE: 1

# [led_effect panel_idle]
# autostart:              true
# frame_rate:             24
# leds:
#     neopixel:case_light
# layers:
#     breathing  10 1 top (.5,.5,1)

[led_effect panel_idle]
autostart:              true
frame_rate:             24
leds:
    neopixel:case_light
layers:
    gradient  0.3  1 add (0.3, 0.0, 0.0),(0.0, 0.3, 0.0),(0.0, 0.0, 0.3)

[led_effect chamber_default]
autostart:              true
frame_rate:             24
leds:
    neopixel:case_light
layers:
    static 1 0 top (0, 0, 0, 0.6)


[led_effect probe_flash]
autostart:              true
frame_rate:             24
leds:
    #neopixel:sb_leds
    neopixel:case_light
endstops:
    x, y, z, probe
layers:
    homing 2.5 0 add (0.3, 0.3, 0.4, 0.3)


[led_effect chamber_heating]
frame_rate:             24
leds:
    neopixel:case_light (1-8)
    neopixel:case_light (16-9)
heater:                 heater_bed
layers:
    heaterfire 1 0 top (0.9,0.1,0.0,0.1),(0.9,0.6,0.0,0.1) 


[led_effect status_idle]
autostart:              true
frame_rate:             24
leds:
    neopixel:sb_leds
layers:
    breathing     6   0     add        (0.31, 0.31, 0.18)
    static        1   0     top        (0.03, 0.03, 0.025)


[led_effect sb_leds_heating_pla]
frame_rate:             24
leds:
    neopixel:sb_leds
heater:                 heater_bed
layers:
    temperature   20 60  add      (0.0,0.0,1.0) 
    strobe        2  2   add      (0.0,0.0,0.3) 
    static        1  1   bottom   (0.1,0.1,0.1) 


[led_effect sb_leds_heating_abs]
frame_rate:             24
leds:
    neopixel:sb_leds
heater:                 heater_bed
layers:
    temperature   20 110 add      (1.0,0.0,0.0) 
    strobe        2  2   add      (0.3,0.0,0.0)
    static        1  1   bottom   (0.1,0.1,0.1) 


[led_effect sb_leds_printing_pla]
frame_rate:             24
leds:
   neopixel:sb_leds
heater:                 heater_bed
layers:
    static        1  1   top      (0.0,0.0,1.0) 


[led_effect sb_leds_printing_abs]
frame_rate:             24
leds:
    neopixel:sb_leds
heater:                 heater_bed
layers:
    static        1  1   top      (1.0,0.0,0.0)

[led_effect busy]
autostart:              true
frame_rate:             24
leds:
    neopixel:sb_leds
    neopixel:case_light
layers:
    static 1 0 top (0, 0, 0, 0.6)


[led_effect test_heating_pla]
frame_rate:             24
leds:
    neopixel:sb_leds
heater:                 heater_bed
layers:
    #heater       20  60   top         (0.06, 0.06, 0.05), (0.06, 0.06, 0.8)
    linearfade    3   0    add         (0.0, 0.0, 0.0), (0, 0, 0.6)
    static        1   0    top         (0.37, 0.37, 0.23)


[led_effect test_heating_abs]
frame_rate:             24
leds:
    neopixel:sb_leds
heater:                 heater_bed
layers:
    strobe        1   1    add         (0.5, 0.2, 0.1)
    linearfade    3   0    top         (0.8, 0.2, 0.0), (0.8, 0, 0)
    #heater        40  0    top         (0.8, 0.2, 0.0), (0.8, 0, 0), (0.8, 0, 0)


[led_effect test_printing_pla]
frame_rate:             24
leds:
    neopixel:sb_leds
heater:                 heater_bed
layers:
    linearfade    3   0    top         (0, 0, 0.6), (0.2, 0.2, 0.6)
    #heater        40  0    top         (0.8, 0.0, 0.0), (0, 0, 0.6), (0, 0, 0.6)


[led_effect test_printing_abs]
frame_rate:             24
leds:
    neopixel:sb_leds
heater:                 heater_bed
layers:    
    linearfade    3   0    top         (0.8, 0, 0), (0.8, 0.2, 0.2)
    #heater        40  0    top         (0.8, 0.2, 0.0), (0.8, 0, 0), (0.8, 0, 0)

#MACROS
[gcode_macro status_ready]
gcode:
  STOP_LED_EFFECTS
  SET_LED_EFFECT EFFECT=status_idle
  SET_LED_EFFECT EFFECT=chamber_default

[gcode_macro status_busy]
gcode:
  STOP_LED_EFFECTS
  SET_LED_EFFECT EFFECT=busy

[gcode_macro status_heating]
gcode:
  SET_LED_EFFECT EFFECT=status_idle STOP=1
  {% set BED = params.BED|default(110)|int %}
  {% set HOTEND = params.HOTEND|default(250)|int %}

  {% if BED < 100 %}                ;  set dial color to bed ABS/PLA
      SET_LED_EFFECT EFFECT=sb_leds_heating_pla
  {% else %}
      SET_LED_EFFECT EFFECT=sb_leds_heating_abs
  {% endif %}

[gcode_macro status_leveling]
gcode:
    STOP_LED_EFFECTS
    SET_LED_EFFECT EFFECT=status_idle
    SET_LED_EFFECT EFFECT=chamber_default
    SET_LED_EFFECT EFFECT=probe_flash

[gcode_macro status_homing]
gcode:
    STOP_LED_EFFECTS
    SET_LED_EFFECT EFFECT=status_idle
    SET_LED_EFFECT EFFECT=chamber_default
    SET_LED_EFFECT EFFECT=probe_flash

[gcode_macro status_cleaning]
gcode:
    STOP_LED_EFFECTS
    SET_LED_EFFECT EFFECT=status_idle
    SET_LED_EFFECT EFFECT=chamber_default
    SET_LED_EFFECT EFFECT=probe_flash

[gcode_macro status_meshing]
gcode:
    STOP_LED_EFFECTS
    SET_LED_EFFECT EFFECT=status_idle
    SET_LED_EFFECT EFFECT=chamber_default
    SET_LED_EFFECT EFFECT=probe_flash

[gcode_macro status_calibrating_z]
gcode:
    STOP_LED_EFFECTS
    SET_LED_EFFECT EFFECT=status_idle
    SET_LED_EFFECT EFFECT=chamber_default
    SET_LED_EFFECT EFFECT=probe_flash

[gcode_macro status_printing]
gcode:
  SET_LED_EFFECT EFFECT=status_idle STOP=1
  {% set BED = params.BED|default(110)|int %}
  {% set HOTEND = params.HOTEND|default(250)|int %}
  {% if HOTEND < 230 %}             ;  set front button color to printing ABS/PLA
      SET_LED_EFFECT EFFECT=sb_leds_heating_pla STOP=1
      SET_LED_EFFECT EFFECT=sb_leds_printing_pla
  {% else %}
      SET_LED_EFFECT EFFECT=sb_leds_heating_abs STOP=1
      SET_LED_EFFECT EFFECT=sb_leds_printing_abs
  {% endif %}